---
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
---

<MainLayout title="Home">
    
    <div class="container home-hero-spacer">
        <div class="ps-3">
            <div class="d-flex align-items-center">
                <div class="hero-accent"></div>
                <h1 class="text-holder">Welcome to Grace Baptist Church</h1>
            </div>
        </div>
    </div>

    <div class="container">
        <section class="content-card dark-card text-center">
            <div class="d-flex justify-content-center align-items-center mb-5">
                <div class="divider-line bg-red"></div>
                <h2 class="mx-4 mb-0 fw-bold text-uppercase text-white letter-spacing-1">Quick Info</h2>
                <div class="divider-line bg-red"></div>
            </div>

            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                    <div class="info-item">
                        <div class="mb-3 d-flex justify-content-center">
                            <div class="icon-circle">
                                <Icon name="fa-solid:calendar-alt" size="1.5em" />
                            </div>
                        </div>
                        <h5 class="text-white fw-bold mb-2">Service Times</h5>
                        <p class="text-white-50 small">Sunday Worship: 10:00 AM</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                    <div class="info-item">
                        <div class="mb-3 d-flex justify-content-center">
                            <div class="icon-circle">
                                <Icon name="fa-solid:lock" size="1.5em" />
                            </div>
                        </div>
                        <h5 class="text-white fw-bold mb-2">Secure</h5>
                        <p class="text-white-50 small">Safe and Welcoming Environment</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                    <div class="info-item">
                        <div class="mb-3 d-flex justify-content-center">
                            <div class="icon-circle">
                                <Icon name="fa-solid:heartbeat" size="1.5em" />
                            </div>
                        </div>
                        <h5 class="text-white fw-bold mb-2">Community</h5>
                        <p class="text-white-50 small">Caring Community Support</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
                    <div class="info-item">
                        <div class="mb-3 d-flex justify-content-center">
                            <div class="icon-circle">
                                <Icon name="fa-solid:bus" size="1.5em" />
                            </div>
                        </div>
                        <h5 class="text-white fw-bold mb-2">Transport</h5>
                        <p class="text-white-50 small">Transportation Available</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div class="container">
        <section id="latest-sermon-banner" class="w-100 position-relative d-flex align-items-center justify-content-center" style="min-height: 500px; background-color: #1a1a1a; margin-top: 80px;">
            <div class="spinner-border text-light" role="status"></div>
        </section>
    </div>

    <div class="container mt-3">
        <div class="text-center mb-3 p-3" style="background-color: #8b0000; border-radius: 10px; color: white;">
            <h2 class="fw-bold display-6">Events</h2>
            <p class="text-white">to encourage you and connect with others</p>
        </div>

        <div class="row g-4" id="upcoming-events-container">
            <div class="col-12 text-center py-5">
                 <div class="spinner-border text-danger" role="status"></div>
            </div>
        </div>

        <div class="text-center mt-3 mb-3">
            <a href="/grace-baptist-church/events" class="btn btn-red px-4 py-2 fw-bold text-uppercase" style="letter-spacing: 1px;">
                View Upcoming Events
            </a>
        </div>
    </div>

</MainLayout>

<script>
    import { supabase } from "../lib/supabase";

    document.addEventListener("astro:page-load", async () => {
        const sermonBanner = document.getElementById("latest-sermon-banner");
        const eventsContainer = document.getElementById("upcoming-events-container");

        function getThumbnail(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            const id = (match && match[2].length === 11) ? match[2] : null;
            return id ? `https://i.ytimg.com/vi/${id}/maxresdefault.jpg` : null; 
        }

        async function fetchLatestSermon() {
            if(!sermonBanner) return;
            const { data, error } = await supabase.from('sermons').select('*').order('date_preached', { ascending: false }).limit(1);

            if (error || !data || data.length === 0) {
                sermonBanner.innerHTML = `<div class="text-white">No sermons found.</div>`;
                return;
            }

            const sermon = data[0];
            const thumb = getThumbnail(sermon.video_url);
            
            const bgStyle = thumb 
                ? `background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)), url('${thumb}'); background-size: cover; background-position: center; background-attachment: fixed;` 
                : `background: #111;`;

            sermonBanner.style.cssText = `min-height: 550px; ${bgStyle}`;

            const videoIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" fill="currentColor" class="me-2"><path d="M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zM559.1 99.8c10.4 5.6 16.9 16.4 16.9 28.2V384c0 11.9-6.5 22.6-16.9 28.2s-23 5-32.9-1.6l-96-64L416 337.1V320 192 174.9l14.2-9.5 96-64c9.8-6.5 22.4-7.2 32.9-1.6z"/></svg>`;

            sermonBanner.innerHTML = `
                <div class="container text-center text-white fade-in-up">
                    <p class="fst-italic mb-2 fs-4" style="font-family: serif;">Latest Sermon</p>
                    <h1 class="fw-bold mb-5 display-4">${sermon.title}</h1>
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <a href="${sermon.video_url}" target="_blank" class="btn btn-outline-light rounded-0 px-4 py-3 d-flex align-items-center fw-bold text-uppercase" style="border: 2px solid white; letter-spacing: 1px;">
                            ${videoIcon} Watch Now
                        </a>
                        <a href="/grace-baptist-church/preaching" class="btn btn-outline-light rounded-0 px-4 py-3 fw-bold text-uppercase" style="border: 2px solid white; letter-spacing: 1px;">
                            View All Sermons
                        </a>
                    </div>
                </div>
            `;
        }

        async function fetchUpcomingEvents() {
            if(!eventsContainer) return;
            const { data, error } = await supabase.from('events').select('*').order('event_date', { ascending: true }).limit(4);

            if (error || !data || data.length === 0) {
                eventsContainer.innerHTML = `<div class="col-12 text-center text-muted">No upcoming events found.</div>`;
                return;
            }

            eventsContainer.innerHTML = data.map(event => {
                const date = new Date(event.event_date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                
                const bgStyle = event.image_url 
                    ? `background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('${event.image_url}'); background-size: cover; background-position: center; transition: transform 0.5s ease;` 
                    : `background: linear-gradient(135deg, #444, #222);`;

                return `
                <div class="col-md-6">
                    <div class="event-banner-card position-relative rounded-3 overflow-hidden d-flex flex-column justify-content-center align-items-center text-center p-5 text-white" style="height: 300px; ${bgStyle}">
                        <h3 class="fw-bold mb-2">${event.title}</h3>
                        <p class="fs-5 mb-4 opacity-75">${dateStr}</p>
                        <a href="/grace-baptist-church/events" class="btn btn-light text-dark fw-bold px-4 py-2 small text-uppercase" style="letter-spacing: 1px;">Learn More</a>
                    </div>
                </div>`;
            }).join('');
        }

        fetchLatestSermon();
        fetchUpcomingEvents();
    });
</script>

<style>
    .fade-in-up { animation: fadeInUp 0.8s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    .event-banner-card { position: relative; z-index: 1; }
    .event-banner-card:hover { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
</style>