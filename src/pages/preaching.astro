---
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
---

<MainLayout title="Preaching">
    
    <div class="container page-content">
        
        <section class="text-center mb-5">
            <h1 class="text-uppercase fw-bold">Preaching</h1>
            <p class="lead">At Grace Baptist Church, we are committed to sharing the love and teachings of 
                Jesus Christ with our community and beyond. </p>
        </section>

        <section class="content-card mb-5">
            <h4 class="fw-bold mb-4">Filter Sermons</h4>
            
            <div class="row g-3">
                <div class="col-8">
                    <label for="searchSermon" class="form-label text-muted">Search for Sermon</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchSermon" placeholder="Title or keyword...">
                        <span class="input-group-text bg-white border-start-0">
                            <Icon name="fa-solid:search" class="text-muted" />
                        </span>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <label for="dateSelect" class="form-label text-muted">Date</label>
                    <input type="date" class="form-control" id="dateSelect">
                </div>

                <div class="col-12 text-end mt-4">
                    <button id="searchBtn" class="btn btn-outline-red text-uppercase px-5">
                        Search
                    </button>
                </div>
            </div>
        </section>

        <div id="sermon-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        </div>

        <nav aria-label="Sermon page navigation" class="mt-5">
            <ul id="pagination" class="pagination justify-content-center">
            </ul>
        </nav>

    </div>

</MainLayout>

<style>
    :global(.sermon-card), 
    .content-card {
        background: #ffffff;
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); 
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    :global(.sermon-card:hover) {
        transform: translateY(-8px);
        box-shadow: 0 20px 50px rgba(139, 0, 0, 0.15); 
    }

    :global(.sermon-card-image) {
        height: 200px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 3rem;
        position: relative;
    }

    :global(.sermon-card-image::after) {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: #8B0000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    :global(.sermon-card:hover .sermon-card-image::after) {
        opacity: 1;
    }

    :global(.sermon-card-body) {
        padding: 1.75rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    :global(.sermon-title) {
        font-weight: 800;
        font-size: 1.35rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        letter-spacing: -0.5px;
        line-height: 1.3;
    }

    :global(.meta-tag) {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #8B0000;
        background-color: rgba(139, 0, 0, 0.05);
        padding: 4px 10px;
        border-radius: 30px;
        display: inline-block;
        margin-bottom: 8px;
        align-self: flex-start;
    }

    .form-control, .form-select {
        border-radius: 12px; 
        border: 1px solid #e0e0e0;
        padding: 12px 15px;
        background-color: #f9f9f9;
        transition: all 0.2s ease;
        box-shadow: none; 
    }

    .form-control:focus, .form-select:focus {
        background-color: #fff;
        border-color: #8B0000;
        box-shadow: 0 0 0 4px rgba(139, 0, 0, 0.1); 
    }

    .input-group-text {
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        background: white;
    }

    :global(.btn-red) {
        background-color: #8B0000;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        padding: 10px 20px;
        transition: all 0.3s ease;
        border: none;
    }

    :global(.btn-red:hover) {
        background-color: #a52a2a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
    }

    :global(.btn-outline-red) {
        color: #8B0000;
        border: 2px solid #8B0000;
        border-radius: 8px;
        font-weight: 600;
        background: transparent;
        transition: all 0.3s ease;
    }

    :global(.btn-outline-red:hover) {
        background-color: #8B0000;
        color: white;
        box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
    }

    :global(.page-link) {
        color: #555;
        border: none;
        margin: 0 6px;
        width: 45px; 
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        
        border-radius: 50% !important; 
        
        font-weight: 700;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    :global(.page-item.active .page-link) {
        background-color: #8B0000;
        color: white;
        box-shadow: 0 4px 10px rgba(139, 0, 0, 0.4);
        transform: scale(1.1); 
    }
    
    :global(.page-link:hover:not(.active)) {
        background-color: #fff;
        color: #8B0000;
        transform: translateY(-2px);
    }
</style>

<script>
    interface Sermon {
        id: number;
        title: string;
        excerpt: string;
        book: string;
        date: string;
        hasAudio: boolean;
        hasVideo: boolean;
        videoLink?: string; 
        thumbnail?: string; 
    }

    document.addEventListener("astro:page-load", () => {
        const sermonDataUrl = "/api/sermons.json"; 

        const cardsContainer = document.getElementById("sermon-grid");
        const paginationContainer = document.getElementById("pagination");
        const searchInput = document.getElementById("searchSermon") as HTMLInputElement;
        const bookSelect = document.getElementById("bookSelect") as HTMLSelectElement;
        const dateInput = document.getElementById("dateSelect") as HTMLInputElement;
        const searchButton = document.getElementById("searchBtn");

        if (!cardsContainer) return;

        let allSermons: Sermon[] = [];
        let filteredSermons: Sermon[] = [];
        let currentPage = 1;
        const cardsPerPage = 6;

        const populateBookOptions = (sermons: Sermon[]) => {
            if (!bookSelect) return;
            const books = new Set(sermons.map((s) => s.book).filter((b) => b));
            bookSelect.innerHTML = '<option selected value="-Any-">-Any-</option>';
            books.forEach((book) => {
                const option = document.createElement("option");
                option.value = book;
                option.textContent = book;
                bookSelect.appendChild(option);
            });
        };

        const createSermonCard = (sermon: Sermon) => {
            const dateObj = new Date(sermon.date);
            const formattedDate = isNaN(dateObj.getTime())
                ? "Date Unavailable"
                : dateObj.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });

            const imageContent = sermon.thumbnail 
                ? `<img src="${sermon.thumbnail}" alt="${sermon.title}" style="width:100%; height:100%; object-fit:cover;">`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 512 512"><path fill="currentColor" d="M149.1 108.6c-46 0-83.3 37.3-83.3 83.3c0 46 37.3 83.3 83.3 83.3c46 0 83.3-37.3 83.3-83.3c0-46-37.3-83.3-83.3-83.3m0 132.6c-27.2 0-49.3-22.1-49.3-49.3s22.1-49.3 49.3-49.3s49.3 22.1 49.3 49.3s-22.1 49.3-49.3 49.3M397.9 237l-56.1-57.1l-63.5 63.7l-82.6-72.9l-123.6 142h375zM48 276.5l98.3-113l75.6 66.8l65.6-65.9l80.2 81.6H84.1z"/><path fill="currentColor" d="M448 32H64C28.6 32 0 60.6 0 96v320c0 35.4 28.6 64 64 64h384c35.4 0 64-28.6 64-64V96c0-35.4-28.6-64-64-64m30 384c0 16.5-13.5 30-30 30H64c-16.5 0-30-13.5-30-30V96c0-16.5 13.5-30 30-30h384c16.5 0 30 13.5 30 30z"/></svg>`;

            const watchButton = sermon.videoLink 
                ? `<a href="${sermon.videoLink}" target="_blank" class="btn btn-sm btn-outline-red flex-fill py-2"><i class="fas fa-video me-2"></i>Watch</a>`
                : (sermon.hasVideo ? `<a href="#" class="btn btn-sm btn-outline-red flex-fill py-2"><i class="fas fa-video me-2"></i>Watch</a>` : '');

            return `
                <div class="col">
                    <div class="sermon-card">
                        <div class="sermon-card-image">
                            ${imageContent}
                        </div>
                        <div class="sermon-card-body">
                            <div class="meta-tag">
                                ${sermon.book || "General"}
                            </div>

                            <div class="sermon-title">${sermon.title}</div>
                            
                            <div class="small text-muted mb-3 d-flex align-items-center">
                                <svg class="me-2" style="width:14px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#6c757d" d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.6 64 0 92.6 0 128v16h448v-16c0-35.4-28.6-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM448 192H0V464c0 35.4 28.6 64 64 64h320c35.4 0 64-28.6 64-64V192z"/></svg>
                                ${formattedDate}
                            </div>
                            
                            <p class="text-muted small mb-4 flex-grow-1" style="line-height: 1.6;">
                                ${sermon.excerpt}
                            </p>
                            
                            <div class="d-flex gap-2 mt-auto">
                                ${sermon.hasAudio ? `<a href="#" class="btn btn-sm btn-red flex-fill py-2"><i class="fas fa-headphones me-2"></i>Listen</a>` : ''}
                                ${watchButton}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCards = () => {
            if (!cardsContainer) return;
            cardsContainer.innerHTML = "";
            const start = (currentPage - 1) * cardsPerPage;
            const end = start + cardsPerPage;
            const sermonsToRender = filteredSermons.slice(start, end);
            if (sermonsToRender.length === 0) {
                cardsContainer.innerHTML = '<p class="text-center text-muted w-100 p-5">No sermons found matching your criteria.</p>';
                return;
            }
            sermonsToRender.forEach((sermon) => {
                cardsContainer.insertAdjacentHTML("beforeend", createSermonCard(sermon));
            });
        };

        const renderPagination = () => {
             if (!paginationContainer) return;
            paginationContainer.innerHTML = "";
            const totalPages = Math.ceil(filteredSermons.length / cardsPerPage);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const isActive = i === currentPage ? "active" : "";
                const li = document.createElement('li');
                li.className = `page-item ${isActive}`;
                
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = i.toString(); 
                a.onclick = (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderCards();
                    renderPagination();
                    const card = document.querySelector('.content-card');
                    if (card) card.scrollIntoView({ behavior: 'smooth' });
                };

                li.appendChild(a);
                paginationContainer.appendChild(li);
            }
        }

        const applyFilters = () => {
            const searchText = searchInput ? searchInput.value.toLowerCase() : "";
            const bookFilter = bookSelect ? bookSelect.value : "-Any-";
            const dateFilter = dateInput ? dateInput.value : "";

            filteredSermons = allSermons.filter((sermon) => {
                const textMatch = sermon.title.toLowerCase().includes(searchText) ||
                                  sermon.excerpt.toLowerCase().includes(searchText);
                const bookMatch = bookFilter === "-Any-" || sermon.book === bookFilter;
                const dateMatch = dateFilter === "" || sermon.date === dateFilter;

                return textMatch && bookMatch && dateMatch;
            });

            currentPage = 1;
            renderCards();
            renderPagination();
        };

         if (searchButton) searchButton.addEventListener("click", (e) => { e.preventDefault(); applyFilters(); });
        if (searchInput) searchInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") { e.preventDefault(); applyFilters(); }
        });
        if (bookSelect) bookSelect.addEventListener("change", applyFilters);
        if (dateInput) dateInput.addEventListener("change", applyFilters);


        const initialize = async () => {
            try {
                const response = await fetch(sermonDataUrl);
                if (!response.ok) throw new Error("Failed to load data");
                
                allSermons = await response.json();
                populateBookOptions(allSermons);
                filteredSermons = allSermons;

                renderCards();
                renderPagination();
            } catch (error) {
                console.error("Error initializing sermon data:", error);
                if (cardsContainer) {
                    cardsContainer.innerHTML = '<p class="text-danger text-center w-100">Failed to load sermons.</p>';
                }
            }
        };

        initialize();
    });
</script>