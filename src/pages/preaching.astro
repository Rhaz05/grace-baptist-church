---
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
---

<MainLayout title="Preaching">
    
    <div class="container page-content" style="padding-top: 70px;">
        
        <section class="text-center" style="padding-bottom: 40px;">
            <h1 class="text-uppercase fw-bold">Preaching</h1>
            <p class="lead">At Grace Baptist Church, we are committed to sharing the love and teachings of Jesus Christ.</p>
        </section>

        <section class="content-card mb-5" style="background-color: #f4f4f4;">
            <h4 class="fw-bold mb-4">Filter Sermons</h4>
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="searchSermon" class="form-label text-muted">Search for Sermon</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchSermon" placeholder="Title or keyword...">
                        <span class="input-group-text bg-white border-start-0">
                            <Icon name="fa-solid:search" class="text-muted" />
                        </span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="dateSelect" class="form-label text-muted">Date</label>
                    <input type="date" class="form-control" id="dateSelect">
                </div>
            </div>
        </section>

        <div id="sermon-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
             <div class="col-12 text-center py-5">
                 <div class="spinner-border text-danger" role="status"></div>
                 <p class="mt-2 text-muted">Loading sermons...</p>
             </div>
        </div>

        <nav aria-label="Sermon page navigation" class="mt-5">
            <ul id="pagination" class="pagination justify-content-center"></ul>
        </nav>
    </div>
</MainLayout>

<style>
    :global(.sermon-card), .content-card {
        background: #ffffff; border: none; border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        height: 100%; display: flex; flex-direction: column;
    }
    :global(.sermon-card:hover) { transform: translateY(-8px); box-shadow: 0 20px 50px rgba(139, 0, 0, 0.15); }
    :global(.sermon-card-image) {
        height: 200px; background: #eee;
        display: flex; align-items: center; justify-content: center; position: relative;
    }
    :global(.sermon-card-image::after) {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
        background: #8B0000; opacity: 0; transition: opacity 0.3s ease;
    }
    :global(.sermon-card:hover .sermon-card-image::after) { opacity: 1; }
    :global(.sermon-card-body) { padding: 1.75rem; flex-grow: 1; display: flex; flex-direction: column; }
    :global(.sermon-title) { font-weight: 800; font-size: 1.35rem; margin-bottom: 0.5rem; color: #2c3e50; line-height: 1.3; }
    :global(.meta-tag) {
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #8B0000;
        background-color: rgba(139, 0, 0, 0.05); padding: 4px 10px; border-radius: 30px;
        display: inline-block; margin-bottom: 8px; align-self: flex-start;
    }
    .form-control { border-radius: 12px; border: 1px solid #e0e0e0; padding: 12px 15px; background-color: #f9f9f9; }
    .input-group-text { border-radius: 12px; border: 1px solid #e0e0e0; background: white; }
    :global(.btn-outline-red) { color: #8B0000; border: 2px solid #8B0000; border-radius: 8px; font-weight: 600; transition: 0.3s; }
    :global(.btn-outline-red:hover) { background-color: #8B0000; color: white; }
    :global(.page-link) { color: #555; border: none; margin: 0 6px; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50% !important; font-weight: 700; }
    :global(.page-item.active .page-link) { background-color: #8B0000; color: white; }
</style>

<script>
    import { supabase } from "../lib/supabase";

    document.addEventListener("astro:page-load", async () => {
        const grid = document.getElementById("sermon-grid");
        const paginationContainer = document.getElementById("pagination");
        const searchInput = document.getElementById("searchSermon") as HTMLInputElement;
        const dateInput = document.getElementById("dateSelect") as HTMLInputElement;

        if (!grid) return;

        let allSermons: any[] = [];
        let filteredSermons: any[] = [];
        const itemsPerPage = 6;
        let currentPage = 1;

        function getThumbnail(url: string) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            const id = (match && match[2].length === 11) ? match[2] : null;
            return id ? `https://i.ytimg.com/vi/${id}/mqdefault.jpg` : null;
        }

        async function fetchSermons() {
            const { data, error } = await supabase
                .from('sermons')
                .select('*')
                .order('date_preached', { ascending: false });

            if (error || !data) {
                grid!.innerHTML = `<div class="col-12 text-center py-5 text-danger">Error loading sermons. Please refresh.</div>`;
                return;
            }

            allSermons = data;
            applyFilter(); 
        }

        function render() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const toShow = filteredSermons.slice(start, end);

            if (toShow.length === 0) {
                grid!.innerHTML = `<div class="col-12 text-center py-5 text-muted">No sermons found matching your search.</div>`;
                paginationContainer!.innerHTML = '';
                return;
            }

            grid!.innerHTML = toShow.map(s => {
                const thumb = getThumbnail(s.video_url);
                const thumbStyle = thumb 
                    ? `background-image: url('${thumb}'); background-size: cover; background-position: center;`
                    : `background-color: #eee;`; 
                
                const calendarIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="currentColor" class="me-2"><path d="M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z"/></svg>`;
                const videoIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" fill="currentColor" class="me-2"><path d="M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128zM559.1 99.8c10.4 5.6 16.9 16.4 16.9 28.2V384c0 11.9-6.5 22.6-16.9 28.2s-23 5-32.9-1.6l-96-64L416 337.1V320 192 174.9l14.2-9.5 96-64c9.8-6.5 22.4-7.2 32.9-1.6z"/></svg>`;

                const dateStr = new Date(s.date_preached).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });

                return `
                <div class="col sermon-item">
                    <div class="sermon-card">
                        <div class="sermon-card-image" style="${thumbStyle}"></div>
                        <div class="sermon-card-body">
                            <div class="meta-tag">Sermon</div>
                            <div class="sermon-title">${s.title}</div>
                            <div class="small text-muted mb-3 d-flex align-items-center">
                                ${calendarIcon}
                                ${dateStr}
                            </div>
                            <p class="text-muted small mb-4 flex-grow-1 clamp-3">${s.description || 'No description available.'}</p>
                            <div class="d-flex gap-2 mt-auto">
                                <a href="${s.video_url}" target="_blank" class="btn btn-sm btn-outline-red flex-fill py-2 d-flex align-items-center justify-content-center">
                                    ${videoIcon} Watch
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            renderPagination(Math.ceil(filteredSermons.length / itemsPerPage));
        }

        function renderPagination(totalPages: number) {
            if(!paginationContainer) return;
            paginationContainer.innerHTML = '';
            if(totalPages <= 1) return;

            for(let i=1; i<=totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = (e) => {
                    e.preventDefault();
                    currentPage = i;
                    render();
                    window.scrollTo({top:0, behavior:'smooth'});
                };
                paginationContainer.appendChild(li);
            }
        }

        function applyFilter() {
            const term = searchInput.value.toLowerCase();
            const date = dateInput.value;

            filteredSermons = allSermons.filter(s => {
                const matchesSearch = s.title.toLowerCase().includes(term) || (s.description && s.description.toLowerCase().includes(term));
                const matchesDate = date === "" || s.date_preached === date;
                return matchesSearch && matchesDate;
            });

            currentPage = 1;
            render();
        }

        searchInput?.addEventListener("input", applyFilter);
        dateInput?.addEventListener("change", applyFilter);

        fetchSermons();
    });
</script>