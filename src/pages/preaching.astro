---
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
---

<MainLayout title="Preaching">
    
    <div class="container page-content" style="padding-top: 70px;">
        
        <section class="text-center" style="padding-bottom: 60px;">
            <h1 class="text-uppercase fw-bold">Preaching</h1>
            <p class="lead">At Grace Baptist Church, we are committed to sharing the love and teachings of 
                Jesus Christ with our community and beyond. </p>
        </section>

        <section class="content-card mb-5" style="background-color: #f4f4f4;">
            <h4 class="fw-bold mb-4">Filter Sermons</h4>
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="searchSermon" class="form-label text-muted">Search for Sermon</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchSermon" placeholder="Title or keyword...">
                        <span class="input-group-text bg-white border-start-0">
                            <Icon name="fa-solid:search" class="text-muted" />
                        </span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="dateSelect" class="form-label text-muted">Date</label>
                    <input type="date" class="form-control" id="dateSelect">
                </div>
                <div class="col-12 text-end mt-4">
                    <button id="searchBtn" class="btn btn-outline-red text-uppercase px-5">Search</button>
                </div>
            </div>
        </section>

        <div id="sermon-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <div class="col-12 text-center py-5" id="loader">
                 <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading sermons from YouTube...</p>
            </div>
        </div>

        <nav aria-label="Sermon page navigation" class="mt-5">
            <ul id="pagination" class="pagination justify-content-center"></ul>
        </nav>
    </div>
</MainLayout>

<style>
    :global(.sermon-card), .content-card {
        background: #ffffff; border: none; border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); overflow: hidden;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        height: 100%; display: flex; flex-direction: column;
    }
    :global(.sermon-card:hover) { transform: translateY(-8px); box-shadow: 0 20px 50px rgba(139, 0, 0, 0.15); }
    :global(.sermon-card-image) {
        height: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        display: flex; align-items: center; justify-content: center;
        color: #6c757d; font-size: 3rem; position: relative;
    }
    :global(.sermon-card-image::after) {
        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
        background: #8B0000; opacity: 0; transition: opacity 0.3s ease;
    }
    :global(.sermon-card:hover .sermon-card-image::after) { opacity: 1; }
    :global(.sermon-card-body) { padding: 1.75rem; flex-grow: 1; display: flex; flex-direction: column; }
    :global(.sermon-title) { font-weight: 800; font-size: 1.35rem; margin-bottom: 0.5rem; color: #2c3e50; line-height: 1.3; }
    :global(.meta-tag) {
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #8B0000;
        background-color: rgba(139, 0, 0, 0.05); padding: 4px 10px; border-radius: 30px;
        display: inline-block; margin-bottom: 8px; align-self: flex-start;
    }
    .form-control { border-radius: 12px; border: 1px solid #e0e0e0; padding: 12px 15px; background-color: #f9f9f9; }
    .input-group-text { border-radius: 12px; border: 1px solid #e0e0e0; background: white; }
    :global(.btn-outline-red) { color: #8B0000; border: 2px solid #8B0000; border-radius: 8px; font-weight: 600; transition: 0.3s; }
    :global(.btn-outline-red:hover) { background-color: #8B0000; color: white; }
    :global(.page-link) { color: #555; border: none; margin: 0 6px; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50% !important; font-weight: 700; }
    :global(.page-item.active .page-link) { background-color: #8B0000; color: white; }
</style>

<script>
    interface Sermon {
        id: string;
        title: string;
        excerpt: string;
        book: string;
        date: string;
        hasAudio: boolean;
        hasVideo: boolean;
        videoLink: string;
        thumbnail: string;
    }

    document.addEventListener("astro:page-load", () => {
        const CHANNEL_ID = 'UCJXoVsiDddXFEGxaiN2yKgA';
        const cardsContainer = document.getElementById("sermon-grid");
        const paginationContainer = document.getElementById("pagination");
        const searchInput = document.getElementById("searchSermon") as HTMLInputElement;
        const dateInput = document.getElementById("dateSelect") as HTMLInputElement;
        const searchButton = document.getElementById("searchBtn");

        if (!cardsContainer) return;

        let allSermons: Sermon[] = [];
        let filteredSermons: Sermon[] = [];
        let currentPage = 1;
        const cardsPerPage = 6;

        const createSermonCard = (sermon: Sermon) => {
            const dateObj = new Date(sermon.date);
            const formattedDate = isNaN(dateObj.getTime()) ? "Date Unavailable" : dateObj.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });

            return `
                <div class="col">
                    <div class="sermon-card">
                        <div class="sermon-card-image">
                            <img src="${sermon.thumbnail}" alt="${sermon.title}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="sermon-card-body">
                            <div class="meta-tag">Sermon</div>
                            <div class="sermon-title">${sermon.title}</div>
                            <div class="small text-muted mb-3 d-flex align-items-center">
                                <svg class="me-2" style="width:14px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="#6c757d" d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.6 64 0 92.6 0 128v16h448v-16c0-35.4-28.6-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM448 192H0V464c0 35.4 28.6 64 64 64h320c35.4 0 64-28.6 64-64V192z"/></svg>
                                ${formattedDate}
                            </div>
                            <p class="text-muted small mb-4 flex-grow-1">${sermon.excerpt}</p>
                            <div class="d-flex gap-2 mt-auto">
                                <a href="${sermon.videoLink}" target="_blank" class="btn btn-sm btn-outline-red flex-fill py-2"><i class="fas fa-video me-2"></i>Watch</a>
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        const renderCards = () => {
            cardsContainer.innerHTML = "";
            const start = (currentPage - 1) * cardsPerPage;
            const sermonsToRender = filteredSermons.slice(start, start + cardsPerPage);
            
            if (sermonsToRender.length === 0) {
                cardsContainer.innerHTML = '<p class="text-center text-muted w-100 p-5">No sermons found matching your criteria.</p>';
                return;
            }
            sermonsToRender.forEach(s => cardsContainer.insertAdjacentHTML("beforeend", createSermonCard(s)));
        };

        const renderPagination = () => {
            if (!paginationContainer) return;
            paginationContainer.innerHTML = "";
            const totalPages = Math.ceil(filteredSermons.length / cardsPerPage);
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? "active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = (e) => { e.preventDefault(); currentPage = i; renderCards(); renderPagination(); window.scrollTo({top: 0, behavior: 'smooth'}); };
                paginationContainer.appendChild(li);
            }
        };

        const applyFilters = () => {
            const searchText = searchInput.value.toLowerCase();
            const dateFilter = dateInput.value;
            filteredSermons = allSermons.filter(s => 
                (s.title.toLowerCase().includes(searchText) || s.excerpt.toLowerCase().includes(searchText)) &&
                (dateFilter === "" || s.date === dateFilter)
            );
            currentPage = 1;
            renderCards();
            renderPagination();
        };

        searchButton?.addEventListener("click", applyFilters);
        dateInput?.addEventListener("change", applyFilters);

        const initialize = async () => {
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`)}`);
                const json = await response.json();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(json.contents, "text/xml");
                const entries = Array.from(xmlDoc.querySelectorAll("entry"));

                allSermons = entries.map((entry) => {
                    const videoId = entry.querySelector("videoId")?.textContent || entry.querySelector("id")?.textContent?.split(':').pop() || "";
                    const title = entry.querySelector("title")?.textContent || "Untitled Sermon";
                    const published = entry.querySelector("published")?.textContent || "";
                    const description = entry.querySelector("group > description")?.textContent || "";
                    const link = entry.querySelector("link")?.getAttribute("href") || `https://www.youtube.com/watch?v=${videoId}`;

                    return {
                        id: videoId,
                        title: title,
                        excerpt: description.substring(0, 100) + "...",
                        book: "Sermon",
                        date: published.split("T")[0],
                        hasAudio: false,
                        hasVideo: true,
                        videoLink: link,
                        thumbnail: `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`
                    };
                });
                
                filteredSermons = allSermons;
                renderCards();
                renderPagination();
            } catch (error) {
                cardsContainer.innerHTML = '<p class="text-danger text-center w-100">Error loading data. Please refresh.</p>';
            }
        };

        initialize();
    });
</script>