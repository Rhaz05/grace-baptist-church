---
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
---

<MainLayout title="Sermon Archive">
    
    <div class="container mt-5 mb-5">
        <div class="text-center py-5 bg-light rounded-4 shadow-sm">
            <h1 class="fw-bold display-5 text-uppercase" style="color: #8b0000;">Sermon Archive</h1>
            <p class="text-muted">Access past sermon notes, outlines, and audio files.</p>
        </div>
    </div>

    <div class="container mb-5">
        <div id="loading-spinner" class="text-center py-5">
            <div class="spinner-border text-danger" role="status"></div>
        </div>

        <div id="resource-grid" class="row g-4">
            </div>
    </div>

</MainLayout>

<script>
    import { supabase } from "../lib/supabase";

    document.addEventListener("astro:page-load", async () => {
        const grid = document.getElementById("resource-grid");
        const spinner = document.getElementById("loading-spinner");

        if(!grid) return;

        const getDirectDownloadLink = (url: string) => {
            if (!url) return '#';
            if (url.includes('drive.google.com') && url.includes('/file/d/')) {
                const idMatch = url.match(/\/d\/(.*?)\//);
                if (idMatch && idMatch[1]) return `https://drive.google.com/uc?export=download&id=${idMatch[1]}`;
            }
            return url;
        }

        const downloadIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="currentColor" class="me-2"><path d="M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V274.7l-73.4-73.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l128 128c12.5 12.5 32.8 12.5 45.3 0l128-128c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L288 274.7V32zM64 352c-17.7 0-32 14.3-32 32v32c0 25.3 20.5 45.8 45.8 45.8H434.2c25.3 0 45.8-20.5 45.8-45.8V384c0-17.7-14.3-32-32-32s-32 14.3-32 32v32c0 7.6-6.2 13.8-13.8 13.8H77.8c-7.6 0-13.8-6.2-13.8-13.8V384c0-17.7-14.3-32-32-32z"/></svg>`;
        const fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="4em" viewBox="0 0 384 512" fill="#ddd"><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z"/></svg>`;

        const { data, error } = await supabase
            .from('resources')
            .select('*')
            .eq('category', 'Sermon Archive')
            .order('created_at', { ascending: false });

        if (spinner) spinner.style.display = 'none';

        if (error || !data || data.length === 0) {
            grid.innerHTML = `<div class="col-12 text-center text-muted py-5">No sermon archives found.</div>`;
            return;
        }

        grid.innerHTML = data.map(item => {
            const date = new Date(item.created_at).toLocaleDateString();
            const link = getDirectDownloadLink(item.file_url);
            const bgStyle = item.image_url 
                ? `background-image: url('${item.image_url}'); background-size: cover; background-position: center;` 
                : `background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;`;
            
            const imageContent = item.image_url ? '' : fileIcon;

            return `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm hover-card">
                    <div style="height: 200px; ${bgStyle}" class="rounded-top position-relative">
                        ${imageContent}
                    </div>
                    <div class="card-body d-flex flex-column p-4">
                        <small class="text-muted mb-2 d-block">${date}</small>
                        <h5 class="fw-bold mb-2">${item.title}</h5>
                        <p class="text-muted small mb-4 flex-grow-1">${item.description || 'No description available.'}</p>
                        <a href="${link}" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center fw-bold mt-auto">
                            ${downloadIcon} Download
                        </a>
                    </div>
                </div>
            </div>`;
        }).join('');
    });
</script>

<style>
    .hover-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .hover-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
</style>